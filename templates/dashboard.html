<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot"></i> Crypto Trading Bot Dashboard
            </a>
            <div class="navbar-nav">
                <span class="navbar-text">
                    <i class="fas fa-circle text-success"></i> Online
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        {% if error %}
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i> Error: {{ error }}
        </div>
        {% endif %}

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6>Total Scanned</h6>
                                <h3 id="total-scanned">{{ stats.summary.total_scanned or 0 }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-search fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6>Rug Detected</h6>
                                <h3 id="rug-detected">{{ stats.summary.rug_detected or 0 }}</h3>
                                <small>{{ stats.summary.rug_percentage or 0 }}%</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6>Fake Volume</h6>
                                <h3 id="fake-volume">{{ stats.summary.fake_volume or 0 }}</h3>
                                <small>{{ stats.summary.fake_volume_percentage or 0 }}%</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6>Passed Checks</h6>
                                <h3 id="passed-checks">{{ stats.summary.passed_checks or 0 }}</h3>
                                <small>{{ stats.summary.pass_percentage or 0 }}%</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6>Alerts Sent</h6>
                                <h3 id="alerts-sent">{{ stats.summary.alerts_sent or 0 }}</h3>
                                <small>{{ stats.summary.successful_alerts or 0 }} successful</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-bell fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-dark text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6>Avg Risk Score</h6>
                                <h3 id="avg-risk">{{ stats.summary.average_risk_score or 0 }}</h3>
                                <small>/100</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-shield-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Token Status Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-link"></i> Chain Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chainChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-skull-crossbones"></i> Top Risk Tokens</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>Chain</th>
                                        <th>Risk Score</th>
                                        <th>Market Cap</th>
                                    </tr>
                                </thead>
                                <tbody id="top-risks-table">
                                    {% for token in stats.top_risks %}
                                    <tr>
                                        <td>{{ token.token_name }} ({{ token.token_symbol }})</td>
                                        <td><span class="badge bg-secondary">{{ token.chain.upper() }}</span></td>
                                        <td>
                                            <span class="badge bg-danger">{{ token.risk_score }}</span>
                                        </td>
                                        <td>${{ "{:,.0f}".format(token.market_cap) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-gem"></i> Profitable Alerts</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>Chain</th>
                                        <th>Risk Score</th>
                                        <th>Liquidity</th>
                                    </tr>
                                </thead>
                                <tbody id="profitable-table">
                                    {% for token in stats.profitable_alerts %}
                                    <tr>
                                        <td>{{ token.token_name }} ({{ token.token_symbol }})</td>
                                        <td><span class="badge bg-success">{{ token.chain.upper() }}</span></td>
                                        <td>
                                            <span class="badge bg-success">{{ token.risk_score }}</span>
                                        </td>
                                        <td>${{ "{:,.0f}".format(token.liquidity_usd) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Tokens Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-history"></i> Recent Token Checks</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportData()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Token</th>
                                        <th>Chain</th>
                                        <th>Price</th>
                                        <th>Volume 24h</th>
                                        <th>Market Cap</th>
                                        <th>Status</th>
                                        <th>Risk Score</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-tokens-table">
                                    {% for token in stats.recent_tokens %}
                                    <tr>
                                        <td>{{ token.timestamp.strftime('%H:%M:%S') if token.timestamp else 'N/A' }}</td>
                                        <td>{{ token.token_name }} ({{ token.token_symbol }})</td>
                                        <td><span class="badge bg-info">{{ token.chain.upper() }}</span></td>
                                        <td>${{ "{:.8f}".format(token.price_usd) }}</td>
                                        <td>${{ "{:,.0f}".format(token.volume_24h) }}</td>
                                        <td>${{ "{:,.0f}".format(token.market_cap) }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if token.status == 'rug_risk' else 'warning' if token.status == 'fake_volume' else 'success' }}">
                                                {{ token.status.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if token.risk_score > 70 else 'warning' if token.risk_score > 40 else 'success' }}">
                                                {{ token.risk_score }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-5 mb-3">
            <small class="text-muted">
                Last updated: <span id="last-updated">{{ stats.last_updated or 'Never' }}</span>
            </small>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize charts
        let statusChart, chainChart;
        
        function initCharts() {
            // Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Rug Risk', 'Fake Volume', 'Passed'],
                    datasets: [{
                        data: [
                            {{ stats.summary.rug_detected or 0 }},
                            {{ stats.summary.fake_volume or 0 }},
                            {{ stats.summary.passed_checks or 0 }}
                        ],
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Chain Chart
            const chainCtx = document.getElementById('chainChart').getContext('2d');
            const chainLabels = {{ stats.chain_breakdown.keys() | list | tojson }};
            const chainData = {{ stats.chain_breakdown.values() | list | tojson }};
            
            chainChart = new Chart(chainCtx, {
                type: 'bar',
                data: {
                    labels: chainLabels.map(chain => chain.toUpperCase()),
                    datasets: [{
                        label: 'Tokens Scanned',
                        data: chainData,
                        backgroundColor: ['#007bff', '#ffc107', '#6f42c1']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function refreshData() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    updateDashboard(data);
                })
                .catch(error => {
                    console.error('Error refreshing data:', error);
                });
        }

        function updateDashboard(stats) {
            // Update summary cards
            document.getElementById('total-scanned').textContent = stats.summary.total_scanned || 0;
            document.getElementById('rug-detected').textContent = stats.summary.rug_detected || 0;
            document.getElementById('fake-volume').textContent = stats.summary.fake_volume || 0;
            document.getElementById('passed-checks').textContent = stats.summary.passed_checks || 0;
            document.getElementById('alerts-sent').textContent = stats.summary.alerts_sent || 0;
            document.getElementById('avg-risk').textContent = stats.summary.average_risk_score || 0;
            
            // Update charts
            statusChart.data.datasets[0].data = [
                stats.summary.rug_detected || 0,
                stats.summary.fake_volume || 0,
                stats.summary.passed_checks || 0
            ];
            statusChart.update();
            
            // Update last updated time
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        function exportData() {
            const link = document.createElement('a');
            link.href = '/api/export/token_checks';
            link.download = 'token_checks.json';
            link.click();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
        });
    </script>
</body>
</html>
